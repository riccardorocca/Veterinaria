<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Perro con Abdomen</title> <!-- Nombre que queremos que salga en la pestaña del navegador -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
</head>

<body>
  <iframe style="position:fixed; width:100%; height:100%; border:0" src="" id="api-frame"
    sandbox="allow-scripts allow-same-origin allow-popups allow-forms" allow="autoplay; fullscreen; vr" allowvr
    allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>

  <div class="img-container1"><img src="./img/boton-vet-ucm.png"></div>

  <div class="labels"> <!--Estos son los botones que salen a la dch de la pantalla -->
    <button id="buttonA"><span class="material-symbols-outlined">rotate_90_degrees_cw</span></button>
    <button id="buttonB"><span class="material-symbols-outlined">rotate_90_degrees_ccw</span></button>
    <hr>
    <label class="labelpick" id="labelpick" >clic en un órgano...</label>

    <hr><input class="check1" type="checkbox" id="keyX" onclick="showAndHide('keyX')" checked> <label for="keyX"></label>
    <br><input class="check1" type="checkbox" id="key1" onclick="showGroup('key1')" checked> <label for="key1">Exploración</label>
    <br><input class="check1" type="checkbox" id="keyA" onclick="showAndHide('keyA')" checked> <label for="keyA"></label>

    <p><input class="check1" type="checkbox" id="key2" onclick="showGroup('key2')" checked> <label for="key2">Aparato Digestivo</label>
      <br><input class="check2" type="checkbox" id="keyB" onclick="showAndHide('keyB')" checked> <label for="keyB"></label>
      <br><input class="check2" type="checkbox" id="keyC" onclick="showAndHide('keyC')" checked> <label for="keyC"></label>
      <br><input class="check2" type="checkbox" id="keyD" onclick="showAndHide('keyD')" checked> <label for="keyD"></label>
      <br><input class="check2" type="checkbox" id="keyE" onclick="showAndHide('keyE')" checked> <label for="keyE"></label>
      <br><input class="check2" type="checkbox" id="keyF" onclick="showAndHide('keyF')" checked> <label for="keyF"></label>
      <br><input class="check2" type="checkbox" id="keyG" onclick="showAndHide('keyG')" checked> <label for="keyG"></label>
      <br><input class="check2" type="checkbox" id="keyH" onclick="showAndHide('keyH')" checked> <label for="keyH"></label>
      <br><input class="check2" type="checkbox" id="keyI" onclick="showAndHide('keyI')" checked> <label for="keyI"></label>
      <br><input class="check2" type="checkbox" id="keyJ" onclick="showAndHide('keyJ')" checked> <label for="keyJ"></label>
      <br><input class="check2" type="checkbox" id="keyK" onclick="showAndHide('keyK')" checked> <label for="keyK"></label>

    <p><input class="check1" type="checkbox" id="key5" onclick="showGroup('key5')" checked> <label for="key5">Sistema Endocrino</label>
      <br><input class="check2" type="checkbox" id="keyV" onclick="showAndHide('keyV')" checked> <label for="keyV"></label>
      <br><input class="check2" type="checkbox" id="keyW" onclick="showAndHide('keyW')" checked> <label for="keyW"></label>

    <p><input class="check1" type="checkbox" id="key4" onclick="showGroup('key4')" checked> <label for="key4">Aparato Circulatorio</label>
      <br><input class="check2" type="checkbox" id="keyP" onclick="showAndHide('keyP')" checked> <label for="keyP"></label>
      <br><input class="check2" type="checkbox" id="keyR" onclick="showAndHide('keyR')" checked> <label for="keyR"></label>
      <br><input class="check2" type="checkbox" id="keyT" onclick="showAndHide('keyT')" checked> <label for="keyT"></label>
      <br><input class="check2" type="checkbox" id="keyU" onclick="showAndHide('keyU')" checked> <label for="keyU"></label>

    <p><input class="check1" type="checkbox" id="key3" onclick="showGroup('key3')" checked> <label for="key3">Aparato Urinario</label>
      <br><input class="check2" type="checkbox" id="keyL" onclick="showAndHide('keyL')" checked> <label for="keyL"></label>
      <br><input class="check2" type="checkbox" id="keyM" onclick="showAndHide('keyM')" checked> <label for="keyM"></label>
      <br><input class="check2" type="checkbox" id="keyN" onclick="showAndHide('keyN')" checked> <label for="keyN"></label>
      <br><input class="check2" type="checkbox" id="keyO" onclick="showAndHide('keyO')" checked> <label for="keyO"></label>

  </div>

  <div class="img-container2"><img src="./img/logo-ucm.png"></div>


<!-------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- SCRIPT -->
<!-------------------------------------------------------------------------------------------------------------------------------------------------->
  <script type="text/javascript" src="https://static.sketchfab.com/api/sketchfab-viewer-1.5.1.js"></script>
  <script>
    const model = '7108d299687945e4a07ba59ff1dbb5e7'; // Modelo de referencia a Sketchfab,este fichero cuando lo abres irá al modelo de ese código

    //Redefine los dos botones
    const buttonA = document.getElementById( 'buttonA' );
    const buttonB = document.getElementById( 'buttonB' );

    //Objeto para recoger las correspondencias entre nombres, nodos y botones
    const listedKeys = {};
    listedKeys['keyA'] = { kGroup: 'keyA', Name: 'Esqueleto', nodeName: 'Esqueleto' };

    listedKeys['keyB'] = { kGroup: 'key2', Name: 'Esófago', nodeName: 'Esofago' };
    listedKeys['keyC'] = { kGroup: 'key2', Name: 'Estómago', nodeName: 'Estomago' };
    listedKeys['keyD'] = { kGroup: 'key2', Name: 'Duodeno', nodeName: 'Duodeno' };
    listedKeys['keyE'] = { kGroup: 'key2', Name: 'Yeyuno', nodeName: 'Yeyuno' };
    listedKeys['keyF'] = { kGroup: 'key2', Name: 'Íleon', nodeName: 'Ileon' };
    listedKeys['keyG'] = { kGroup: 'key2', Name: 'Colon', nodeName: 'Colon' };
    listedKeys['keyH'] = { kGroup: 'key2', Name: 'Ciego', nodeName: 'Ciego' };
    listedKeys['keyI'] = { kGroup: 'key2', Name: 'Hígado', nodeName: 'Higado' };
    listedKeys['keyJ'] = { kGroup: 'key2', Name: 'Vesícula', nodeName: 'Vesicula Biliar' };
    listedKeys['keyK'] = { kGroup: 'key2', Name: 'Páncreas', nodeName: 'Pancreas' };

    listedKeys['keyL'] = { kGroup: 'key3', Name: 'Riñones', nodeName: 'Rinones' };
    listedKeys['keyM'] = { kGroup: 'key3', Name: 'Uréteres', nodeName: 'Ureteres' };
    listedKeys['keyN'] = { kGroup: 'key3', Name: 'Vejiga', nodeName: 'Vejiga' };
    listedKeys['keyO'] = { kGroup: 'key3', Name: 'Uretra', nodeName: 'Uretra' };

    listedKeys['keyP'] = { kGroup: 'key4', Name: 'Arteria Aorta', nodeName: 'Arteria Aorta' };
    listedKeys['keyQ1'] = { kGroup: 'key4', Name: 'Arteria Celíaca', nodeName: 'Arteria Celiaca' };
    listedKeys['keyQ3'] = { kGroup: 'key4', Name: 'Arteria Iliaca Externa', nodeName: 'Arteria Iliaca Externa' };
    listedKeys['keyQ4'] = { kGroup: 'key4', Name: 'Arteria Iliaca Interna', nodeName: 'Arteria Iliaca Interna' };
    listedKeys['keyQ2'] = { kGroup: 'key4', Name: 'Arteria Iliaca Produnda', nodeName: 'Arteria Iliaca Profunda' };
    listedKeys['keyQ5'] = { kGroup: 'key4', Name: 'Art. Mesentérica Caudal', nodeName: 'Arteria Mesenterica Caudal' };
    listedKeys['keyQ6'] = { kGroup: 'key4', Name: 'Art. Mesentérica Craneal', nodeName: 'Arteria Mesenterica Craneal' };
    listedKeys['keyQ7'] = { kGroup: 'key4', Name: 'Arteria Renal', nodeName: 'Arteria Renal' };
    listedKeys['keyQ8'] = { kGroup: 'key4', Name: 'Arteria Testicular', nodeName: 'Arteria Testicular' };
    listedKeys['keyR'] = { kGroup: 'key4', Name: 'Vena Cava', nodeName: 'Vena Cava' };
    listedKeys['keyS1'] = { kGroup: 'key4', Name: 'Vena Renal', nodeName: 'Vena Renal' };
    listedKeys['keyS2'] = { kGroup: 'key4', Name: 'Vena Iliaca Externa', nodeName: 'Vena Iliaca Externa' };
    listedKeys['keyS3'] = { kGroup: 'key4', Name: 'Vena Iliaca Interna', nodeName: 'Vena Iliaca Interna' };
    listedKeys['keyT'] = { kGroup: 'key4', Name: 'Vena Porta', nodeName: 'Vena Porta' };
    listedKeys['keyU'] = { kGroup: 'key4', Name: 'Nódulos Linfáticos', nodeName: 'Nodulos Linfaticos' };

    listedKeys['keyV'] = { kGroup: 'key5', Name: 'Glándulas Adrenáles', nodeName: 'Glandulas Adrenales' };
    listedKeys['keyW'] = { kGroup: 'key5', Name: 'Bazo', nodeName: 'Bazo' };

    listedKeys['keyX'] = { kGroup: 'keyX', Name: 'Perro', nodeName: 'Perro' };
    listedKeys['keyY1'] = { kGroup: 'key1', Name: 'Planos', nodeName: 'Planos' };
    listedKeys['keyY2'] = { kGroup: 'key1', Name: 'Epigastrio', nodeName: 'TEpigastrio' };
    listedKeys['keyY3'] = { kGroup: 'key1', Name: 'Hipogastrio', nodeName: 'THipogastrio' };
    listedKeys['keyY4'] = { kGroup: 'key1', Name: 'Mesogastrio', nodeName: 'TMesogastrio' };

    // Rellena el objeto "labelsFor" con las referencias HTML de las etiquetas "label for="
    const labelsFor = {};
    const labelsHTML = document.getElementsByTagName("label");
    for (var i = 0; i < labelsHTML.length; i++) {
        labelsFor[labelsHTML[i].getAttribute("for")] = i;
    };

    // Inserta en cada etiqueta de un órgano, el nombre del órgano mismo
    for (var key in listedKeys) {
      var index = labelsFor[key];
      if (index) { labelsHTML[index].innerText = listedKeys[key].Name; }
    }

    const listedNodes = {};   // Objeto para guardar todos los nodos, también los que tienen el mismo nombre
    const idNodes = {}; // Objeto para guardar los ID de los nodos
    let apiRef; // Referencia a la api, para poder llamarla fuera del evetListener

    //INICIO Sketchfab
    //Asi se llama a la versión de api que esté actualmente
    iframe = document.getElementById('api-frame');
    client = new Sketchfab( iframe);

    error = function () {
      console.error('Sketchfab API Error!');
    },

    success = function (api) {
      apiRef = api; //Aquí ya estamos nombrando a la variable creada por nosotros
                    //para poder usarla fuera de lo de Sketchfab
      api.start();
      // Wait for viewer to be ready
      api.addEventListener('viewerready', function () {
        // Get the object nodes
        api.getNodeMap(function (err, nodes) {
          if (!err) {
            for ( const prop in nodes ) {
              if ( nodes.hasOwnProperty( prop ) ) {
                const name = nodes[ prop ].name;
                const type = nodes[ prop ].type;
                const baseName = name.split('_')[0]; //Nombre base, sin nombre de testura (_...)

                listedNodes[prop] = baseName;
                if (name == baseName && type === "MatrixTransform") {
                  idNodes[name] = nodes[prop].instanceID;
                }
              };
            };

            //Deselecciona algunos botones
            document.getElementById('keyX').checked = false; showAndHide('keyX');
            document.getElementById('key1').checked = false; showGroup('key1')

            //Bucle: cada 0.5 secundos comprueba la orientación de la vista y, si es el caso, da la vuelta a las tre etiquetas
            setInterval(function(){
              api.getCameraLookAt(function(err, camera) {
                var Cx = camera.position[0];
                var Cy = camera.position[1];
                var Tx = camera.target[0];
                var Ty = camera.target[1];
                var azimuth = Math.atan2(Cy-Ty, Cx-Tx);

                if ( azimuth>=-1.857 && azimuth<=1.335 ) {orientation = -Math.PI/2}
                else                                     {orientation = Math.PI/2};
                node = idNodes[listedKeys['keyY2'].nodeName]
                api.rotate(node, [orientation, 0, 1, 0], {duration: 0, easing: 'easeOutQuad'});
                node = idNodes[listedKeys['keyY3'].nodeName]
                api.rotate(node, [orientation, 0, 1, 0], {duration: 0, easing: 'easeOutQuad'});
                node = idNodes[listedKeys['keyY4'].nodeName]
                api.rotate(node, [orientation, 0, 1, 0], {duration: 0, easing: 'easeOutQuad'});
              });
            },1000); //time interval = 500 ms

          };
        });

        //Define coordenadas y botones para ruotar el modelo;
        var XYZa = []; //Punto "desde" para las vistas izquierda, frontal, derecha, posterior
        XYZa.push([0.3496463278114087,-0.0014101106917275424,0.09332838604259208]);
        XYZa.push([-0.05133689443130478,-0.3439883728583083,0.059033221082955445]);
        XYZa.push([-0.32903450225469666,0.03541501455778592,0.07757129113235062]);
        XYZa.push([0.05792695670078959,0.3728206253521797,0.05222790315005561]);

        var XYZb = []; //Punto "hacia" para las vistas izquierda, frontal, derecha, posterior
        XYZb.push([-0.0019292699780640295,0.05176996284730312,-0.029794647691907268]);
        XYZb.push([0.0699172163901642,0.03595388217530738,-0.05806286776152518]);
        XYZb.push([0.06235708326052718,-0.03479902722971384,-0.04347740030027485]);
        XYZb.push([-0.03581797174719082,-0.01726060228515106,-0.056485917540069014]);

        let XYZi = 0;

        buttonA.addEventListener( 'click', function() {
          if (XYZi > 0) { XYZi -- }
          else          { XYZi = 3 };
          api.setCameraLookAt(XYZa[XYZi], XYZb[XYZi], 2);
        });

        buttonB.addEventListener( 'click', function() {
          if (XYZi < 3) { XYZi ++ }
          else          { XYZi = 0 };
          api.setCameraLookAt(XYZa[XYZi], XYZb[XYZi], 2);
        });
/*
        //Uso alternativo del boton B, para mostrar coordenadas y azimuth de la cámara
        buttonB.addEventListener( 'click', function() {
          api.getCameraLookAt(function(err, camera) {
            var Cx = camera.position[0];
            var Cy = camera.position[1];
            var Tx = camera.target[0];
            var Ty = camera.target[1];
            var azimuth = Math.atan2(Cy-Ty, Cx-Tx);
            if (win) {win.close()};
            var win = window.open("", "Title", "toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=500,height=50,top="+(screen.height/2)+",left="+(screen.width/2-250));
            win.document.body.innerHTML = camera.position+"\n"+camera.target+"\n"+azimuth;
          });
        });
*/

        //Código para mostrar el nombre de un órgano cuando se clica en él
        api.addEventListener('click', function(info) {
          if (info.instanceID === null) {
            document.getElementById('labelpick').innerHTML = 'clic en un órgano...';
          }
          else {
            const node = listedNodes[info.instanceID];
            for (kBox in listedKeys) {
              if (listedKeys[kBox].nodeName == node) {
                Name = listedKeys[kBox].Name;
                document.getElementById('labelpick').innerHTML = Name;

              }
            }
          }
        },
        { pick: 'slow' });

      });
    };

    client.init(model, {
      success: success,
      error: error,
      ui_infos: 0,
      ui_controls: 0,
      ui_stop: 1,
      watermark: 1,
      supersample: 0
    });
    //FIN Sketchfab

    // Funciones Propias
    //creadas para solo tener que llamarlas desde el .HTML
    function showAndHide(key) {
      const node = listedKeys[key].nodeName
      const group = listedKeys[key].kGroup
      const checkBox = document.getElementById(key);
      const checkGroup = document.getElementById(group);

      if (checkBox.checked == true && checkGroup.checked == true) {
        apiRef.show(idNodes[node]);
        if (key == "keyP") {displayArterias(true)};
        if (key == "keyR") {displayVenas(true)};
      }
      else {
        apiRef.hide(idNodes[node]);
        if (key == "keyP") {displayArterias(false)};
        if (key == "keyR") {displayVenas(false)};
      };
    };

    function displayArterias(show) {
      const keys = [ "keyQ1", "keyQ2", "keyQ3", "keyQ4", "keyQ5", "keyQ6", "keyQ7", "keyQ8" ];
      for (key of keys) {
        const node = listedKeys[key].nodeName
        if (show) { apiRef.show(idNodes[node]) }
        else      { apiRef.hide(idNodes[node]) }
      }
    }

    function displayVenas(show) {
      const keys = [ "keyS1", "keyS2", "keyS3" ];
      for (key of keys) {
        const node = listedKeys[key].nodeName
        if (show) { apiRef.show(idNodes[node]) }
        else      { apiRef.hide(idNodes[node]) }
      }
    }

    // Activa-Desactiva los grupos de botones
    function showGroup(groupId) {
      const checkGroup = document.getElementById(groupId);

      const group = [];
      switch(groupId) {
        case "key1":
          group.push( "keyY1", "keyY2", "keyY3", "keyY4" );
          break;
        case "key2":
          group.push( "keyB", "keyC", "keyD", "keyE", "keyF", "keyG", "keyH", "keyI", "keyJ", "keyK" );
          break;
        case "key3":
          group.push( "keyL", "keyM", "keyN", "keyO" );
          break;
        case "key4":
          group.push( "keyP", "keyR", "keyT", "keyU" );
          break;
        case "key5":
          group.push( "keyV", "keyW" );
          break;
      };

      for (const key of group) {
        const node = listedKeys[key].nodeName;
        const checkBox = document.getElementById(key);

        if (checkGroup.checked == true) {
          if (groupId == "key1" || checkBox.checked == true) {apiRef.show(idNodes[node])}
          if (key == "keyP" && checkBox.checked == true) {displayArterias(true)}
          if (key == "keyR" && checkBox.checked == true) {displayVenas(true)}
          if (groupId != "key1") {
            checkBox.disabled = false;
            labelsHTML[labelsFor[key]].style.color = 'blue';
          }
        }
        else {
          apiRef.hide(idNodes[node]);
          if (key == "keyP") {displayArterias(false)}
          if (key == "keyR") {displayVenas(false)}
          if (groupId != "key1") {
            checkBox.disabled = true;
            labelsHTML[labelsFor[key]].style.color = 'gray';
          }
        }
      }

    };

  </script>

<!-------------------------------------------------------------------------------------------------------------------------------------------------->
<!-- STYLE -->
<!-------------------------------------------------------------------------------------------------------------------------------------------------->
  <style type="text/css">
    body {
      margin: 0;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Para elegir opacidad de las imagenes de los logos */
    img {
      width: 100%;
      opacity: 0.8;
    }

    /* Para modificar posición y tamaño boton veterinaria UCM */
    .img-container1 {
      position: absolute;
      margin: 0px 5px;
      top: 45px;
      width: 150px;
      right: 0px;
    }

    /* Para modificar posición y tamaño Escudo UCM */
    .img-container2 {
      position: absolute;
      bottom: 22px;
      left: 22px;
      width: 122px;
    }

    /* Para cambiar los espacios entre las líneas de botones */
    p {
      margin-top:    5px;
      margin-bottom: 0px;
    }

    button {
      height: 20px;
      line-height: 21px;
      text-transform: capitalize;
      color: white;
      opacity: 0.8;
      border: none;
      border-radius: 5px;
      text-align: center;
      vertical-align: middle;
      display: block;
      margin-top: 2px;
      background: #1caad9;
    }

    button:hover {opacity: 0.9;}
    button:active {opacity: 1;}

    #buttonA {width: 49%; display: inline;}
    #buttonB {width: 48%; display: inline;}

    /* Estilo de la etiqueta que muestra el nombre del órgano donde se ha hecho click */
    .labelpick {
      display: block;
      color: red;
      font-weight: bold;
      text-align: center;
    }

    /* Estilo de las etiquetas de los botones */
    .labels {
      position: absolute;
      margin: 5px 5px;
      right: 0;
      top: 80px;
      padding: 5px;
      z-index: 1;
      color: blue;
      background-color: white;
      opacity: 0.8;
      font-family: Arial, Helvetica, sans-serif;
      font-size: normal;
      line-height: 1
    }

    /* Estilo de los botones de grupos */
    .check1 {
      cursor: pointer;
      background-color: white;
      color: white;
      width: 10px;
      height: 10px;
      appearance: none;
      border: 1px solid #888;
    }

    .check1:checked {
      background-color: blue;
      background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
    }

    /* Estilo de los botones de órganos */
    .check2 {
      cursor: pointer;
      background-color: white;
      color: white;
      width: 10px;
      height: 10px;
      appearance: none;
      border: 1px solid #888;
      margin-left: 30px;
    }

    .check2:checked {
      background-color: blue;
      background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
    }

    .check2:disabled {
      background-color: lightgray;
      background-image: none;
    }

    .check2:disabled:checked {
      background-color: lightgray;
      background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='black' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
    }
  </style>

</body>
</html>
